{% extends 'base.html' %}
{% block title %}Invoicing - Coffee Manager{% endblock %}
{% block content %}
<section class="card">
  <h2>Batch Invoice</h2>
  <p class="muted">Create a batch invoice for all users covering the period from the last batch invoice (or first usage) until now.</p>
  <form method="post" action="{{ url_for('create_batch_invoice') }}">
    <button class="btn" type="submit">Create Batch Invoice</button>
  </form>
</section>

<section class="card">
  <h2>Create Individual Invoice</h2>
  <p class="muted">Create invoices from the last invoiced moment until now. Only uninvoiced usage will be included.</p>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Token ID</th>
          <th>Username</th>
          <th>Name</th>
          <th>Email</th>
          <th>Uninvoiced Uses</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.token_id }}</td>
          <td>{{ u.user_name }}</td>
          <td>{{ u.name }}</td>
          <td>{{ u.email_address }}</td>
          <td>{{ u.uninvoiced }}</td>
          <td>
            <form method="post" action="{{ url_for('create_invoice', token_id=u.token_id) }}">
              <button class="btn" {% if u.uninvoiced == 0 %}disabled{% endif %}>Create Invoice</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="empty">No users found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Batch Invoices</h2>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Batch Date</th>
          <th>Period</th>
          <th>Users</th>
          <th>Total Items</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for bi in batch_invoices %}
        <tr>
          <td><a href="{{ url_for('view_batch_invoice', batch_id=bi.id) }}">{{ bi.id }}</a></td>
          <td>{{ bi.batch_date }}</td>
          <td>{{ bi.period_start }} – {{ bi.period_end }}</td>
          <td>{{ bi.total_users }}</td>
          <td>{{ bi.total_items }}</td>
          <td>{{ bi.created_at }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="empty">No batch invoices yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Individual Invoices</h2>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Period</th>
          <th>Items</th>
          <th>Status</th>
          <th>Opened</th>
        </tr>
      </thead>
      <tbody>
        {% for i in invoices %}
        <tr>
          <td><a href="{{ url_for('toggle_invoice', invoice_id=i.id) }}" onclick="event.preventDefault(); this.closest('tr').querySelector('form').submit();">{{ i.id }}</a></td>
          <td>{{ i.name or i.user_name }} ({{ i.token_id }})</td>
          <td>{{ i.period_start }} – {{ i.period_end }}</td>
          <td>{{ i.total_items }}</td>
          <td>{{ 'Paid' if i.paid else 'Unpaid' }}</td>
          <td>{{ i.created_at }}</td>
          <form method="post" action="{{ url_for('toggle_invoice', invoice_id=i.id) }}"></form>
        </tr>
        {% else %}
        <tr><td colspan="6" class="empty">No invoices yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}


