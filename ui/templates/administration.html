{% extends 'base.html' %}
{% block title %}Administration{% endblock %}
{% block content %}
<section class="card">
  <h2>Administration</h2>
  <div style="margin-bottom: 1rem; display:flex; gap:.5rem; align-items:center;">
    <form method="post" action="{{ url_for('toggle_scan_mode') }}">
      <input type="hidden" name="enabled" value="{{ 0 if scan_enabled else 1 }}" />
      {% if scan_enabled %}
        <button class="btn" type="submit">Disable Scan Mode</button>
      {% else %}
        <button class="btn" type="submit">Enable Scan Mode</button>
      {% endif %}
    </form>
    <span class="muted">Scan mode {{ 'enabled' if scan_enabled else 'disabled' }}. New badges will {{ 'appear automatically' if scan_enabled else 'not be polled' }}.</span>
  </div>

  <form id="add-user-form" class="card" style="padding: .75rem; margin-bottom:1rem;">
    <div style="font-weight:600; margin-bottom:.5rem;">Add User Manually</div>
    <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:.5rem; align-items:center;">
      <input id="add_token_id" placeholder="Token ID" />
      <input id="add_user_name" placeholder="User Name" />
      <input id="add_name" placeholder="Name" />
      <input id="add_email" placeholder="Email" />
      <input id="add_phone" placeholder="Phone" />
      <button class="btn" type="submit">Add</button>
    </div>
    <div id="add-user-error" class="muted" style="color:#b00020; margin-top:.25rem; display:none;"></div>
  </form>

  {% if scan_enabled %}
  <div id="scan-terminal" style="font-family: monospace; background:#0b0b0b; color:#33ff66; padding:0.75rem 1rem; border-radius:6px; margin-bottom:1rem; border:1px solid #1e1e1e;">
    <div style="color:#9aa0a6; margin-bottom:0.25rem;">Scan Monitor</div>
    <div id="scan-line">waiting for scan...</div>
  </div>
  {% endif %}

  <table class="table" id="users-table">
    <thead>
      <tr>
        <th>Token</th>
        <th>User Name</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>State</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="users-body">
      {% for u in users %}
      <tr data-token="{{ u.token_id }}" data-editing="0">
        <td class="cell-token"><code>{{ u.token_id }}</code></td>
        <td class="cell-user_name"><span>{{ u.user_name or '' }}</span></td>
        <td class="cell-name"><span>{{ u.name or '' }}</span></td>
        <td class="cell-email_address"><span>{{ u.email_address or '' }}</span></td>
        <td class="cell-phone_number"><span>{{ u.phone_number or '' }}</span></td>
        <td class="cell-state">
          {% set state = 'barred' if u.barred else ('active' if u.active else 'inactive') %}
          <span data-state="{{ state }}">{{ state }}</span>
        </td>
        <td class="cell-actions">
          <button class="btn btn-small" onclick="enterEdit(this)">Edit</button>
          <button class="btn btn-small" style="background:#b00020;" onclick="deleteUser(this)">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
// Local cache of edits per token
const localEdits = new Map();

function stateFromFlags(active, barred) {
  if (barred) return 'barred';
  if (active) return 'active';
  return 'inactive';
}

function flagsFromState(state) {
  if (state === 'barred') return { active: 0, barred: 1 };
  if (state === 'active') return { active: 1, barred: 0 };
  return { active: 0, barred: 0 };
}

function makeInput(value, field) {
  const input = document.createElement('input');
  input.value = value || '';
  input.setAttribute('data-field', field);
  input.oninput = () => {/* keep local */};
  return input;
}

function makeStateSelect(state) {
  const sel = document.createElement('select');
  sel.innerHTML = `
    <option value="inactive">inactive</option>
    <option value="active">active</option>
    <option value="barred">barred</option>
  `;
  sel.value = state || 'inactive';
  sel.setAttribute('data-field', '__state');
  return sel;
}

function enterEdit(btn) {
  const tr = btn.closest('tr');
  if (!tr || tr.dataset.editing === '1') return;
  tr.dataset.editing = '1';
  const token = tr.dataset.token;
  const current = rowToObject(tr);
  localEdits.set(token, { ...current });

  tr.querySelector('.cell-user_name').innerHTML = '';
  tr.querySelector('.cell-user_name').appendChild(makeInput(current.user_name, 'user_name'));
  tr.querySelector('.cell-name').innerHTML = '';
  tr.querySelector('.cell-name').appendChild(makeInput(current.name, 'name'));
  tr.querySelector('.cell-email_address').innerHTML = '';
  tr.querySelector('.cell-email_address').appendChild(makeInput(current.email_address, 'email_address'));
  tr.querySelector('.cell-phone_number').innerHTML = '';
  tr.querySelector('.cell-phone_number').appendChild(makeInput(current.phone_number, 'phone_number'));

  const stateCell = tr.querySelector('.cell-state');
  stateCell.innerHTML = '';
  stateCell.appendChild(makeStateSelect(current.state));

  const actions = tr.querySelector('.cell-actions');
  actions.innerHTML = '';
  const doneBtn = document.createElement('button');
  doneBtn.className = 'btn btn-small';
  doneBtn.textContent = 'Done';
  doneBtn.onclick = () => saveEdit(tr);
  actions.appendChild(doneBtn);
}

function rowToObject(tr) {
  const token = tr.dataset.token;
  const user_name = tr.querySelector('.cell-user_name span')?.textContent || tr.querySelector('.cell-user_name input')?.value || '';
  const name = tr.querySelector('.cell-name span')?.textContent || tr.querySelector('.cell-name input')?.value || '';
  const email_address = tr.querySelector('.cell-email_address span')?.textContent || tr.querySelector('.cell-email_address input')?.value || '';
  const phone_number = tr.querySelector('.cell-phone_number span')?.textContent || tr.querySelector('.cell-phone_number input')?.value || '';
  const stateSpan = tr.querySelector('.cell-state span');
  const select = tr.querySelector('.cell-state select');
  const state = select ? select.value : (stateSpan?.dataset.state || 'inactive');
  return { token_id: token, user_name, name, email_address, phone_number, state };
}

async function saveEdit(tr) {
  const token = tr.dataset.token;
  const payload = {};
  const inputs = tr.querySelectorAll('input, select');
  inputs.forEach(el => {
    const field = el.getAttribute('data-field');
    if (field === '__state') return;
    payload[field] = el.value.trim();
  });
  const state = tr.querySelector('select[data-field="__state"]').value;
  Object.assign(payload, flagsFromState(state));
  if (payload.user_name && payload.name) {
    payload.active = 1; payload.barred = 0;
  }
  const resp = await fetch(`{{ url_for('api_update_user', token_id='__T__') }}`.replace('__T__', token), {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if (!resp.ok) { alert('Failed to save'); return; }
  const { user } = await resp.json();
  // Render back to read-only state with server values
  renderRowFromUser(tr, user);
  localEdits.delete(token);
}

function renderRowFromUser(tr, u) {
  tr.dataset.editing = '0';
  tr.querySelector('.cell-user_name').innerHTML = `<span>${u.user_name || ''}</span>`;
  tr.querySelector('.cell-name').innerHTML = `<span>${u.name || ''}</span>`;
  tr.querySelector('.cell-email_address').innerHTML = `<span>${u.email_address || ''}</span>`;
  tr.querySelector('.cell-phone_number').innerHTML = `<span>${u.phone_number || ''}</span>`;
  const state = stateFromFlags(!!u.active, !!u.barred);
  tr.querySelector('.cell-state').innerHTML = `<span data-state="${state}">${state}</span>`;
  tr.querySelector('.cell-actions').innerHTML = `<button class="btn btn-small" onclick="enterEdit(this)">Edit</button><button class="btn btn-small" style="background:#b00020;" onclick="deleteUser(this)">Delete</button>`;
}

function appendUserIfNew(u) {
  const tbody = document.getElementById('users-body');
  if (tbody.querySelector(`tr[data-token="${u.token_id}"]`)) return;
  const tr = document.createElement('tr');
  tr.setAttribute('data-token', u.token_id);
  tr.setAttribute('data-editing', '0');
  tr.innerHTML = `
    <td class="cell-token"><code>${u.token_id}</code></td>
    <td class="cell-user_name"><span>${u.user_name || ''}</span></td>
    <td class="cell-name"><span>${u.name || ''}</span></td>
    <td class="cell-email_address"><span>${u.email_address || ''}</span></td>
    <td class="cell-phone_number"><span>${u.phone_number || ''}</span></td>
    <td class="cell-state"><span data-state="${stateFromFlags(!!u.active, !!u.barred)}">${stateFromFlags(!!u.active, !!u.barred)}</span></td>
    <td class="cell-actions"><button class="btn btn-small" onclick="enterEdit(this)">Edit</button><button class="btn btn-small" style="background:#b00020;" onclick="deleteUser(this)">Delete</button></td>
  `;
  tbody.prepend(tr);
}

function normalizeTokenId(tokenId) {
  // Remove colons, dashes, and convert to lowercase
  return tokenId.replace(/:/g, '').replace(/-/g, '').toLowerCase().trim();
}

document.getElementById('add-user-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const err = document.getElementById('add-user-error');
  err.style.display = 'none'; err.textContent = '';
  let token_id = document.getElementById('add_token_id').value.trim();
  const user_name = document.getElementById('add_user_name').value.trim();
  const name = document.getElementById('add_name').value.trim();
  const email_address = document.getElementById('add_email').value.trim();
  const phone_number = document.getElementById('add_phone').value.trim();
  if (!token_id) { err.textContent = 'Token ID is required.'; err.style.display = 'block'; return; }
  // Normalize token ID format (remove colons/dashes, convert to lowercase)
  token_id = normalizeTokenId(token_id);
  try {
    const resp = await fetch('{{ url_for('api_admin_add_user') }}', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token_id, user_name, name, email_address, phone_number })
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) { throw new Error(data.error || 'Failed to add user'); }
    // Prepend row or update existing one using server values
    appendUserIfNew(data.user);
    const tr = document.querySelector(`tr[data-token="${data.user.token_id}"]`);
    if (tr) { renderRowFromUser(tr, data.user); }
    // Clear inputs
    document.getElementById('add_token_id').value = '';
    document.getElementById('add_user_name').value = '';
    document.getElementById('add_name').value = '';
    document.getElementById('add_email').value = '';
    document.getElementById('add_phone').value = '';
  } catch (e2) {
    err.textContent = e2.message || String(e2);
    err.style.display = 'block';
  }
});

async function pollNewBadges() {
  try {
    const statusResp = await fetch('{{ url_for('api_scan_status') }}');
    if (!statusResp.ok) return;
    const { scan_mode } = await statusResp.json();
    if (!scan_mode) return;
    // Only add new users if any; do not overwrite existing rows or edit states
    const usersResp = await fetch('{{ url_for('api_admin_users') }}');
    if (!usersResp.ok) return;
    const all = await usersResp.json();
    for (const u of all) {
      appendUserIfNew(u);
    }
  } catch (e) { /* ignore */ }
}

setInterval(pollNewBadges, 15000);

async function pollLastScanned() {
  try {
    const statusResp = await fetch('{{ url_for('api_scan_status') }}');
    if (!statusResp.ok) return;
    const { scan_mode } = await statusResp.json();
    if (!scan_mode) return;
    const resp = await fetch('{{ url_for('api_scan_last') }}');
    if (!resp.ok) return;
    const { token, timestamp } = await resp.json();
    const line = document.getElementById('scan-line');
    if (line && (token || timestamp)) {
      line.textContent = token ? `token: ${token}  @ ${timestamp || ''}` : 'waiting for scan...';
    }
  } catch (e) { /* ignore */ }
}

setInterval(pollLastScanned, 2000);

async function deleteUser(btn) {
  const tr = btn.closest('tr');
  if (!tr) return;
  const token = tr.dataset.token;
  if (!confirm(`Are you sure you want to delete user ${token}? This will delete all usage logs, invoices, and cannot be undone!`)) {
    return;
  }
  try {
    const resp = await fetch(`{{ url_for('api_delete_user', token_id='__T__') }}`.replace('__T__', token), {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'}
    });
    if (!resp.ok) {
      const data = await resp.json();
      alert('Failed to delete: ' + (data.error || 'Unknown error'));
      return;
    }
    // Remove row from table
    tr.remove();
  } catch (e) {
    alert('Error deleting user: ' + e.message);
  }
}
</script>

{% endblock %}